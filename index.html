<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PRV â€“ Modes de garde (carte + stacked + cross-filters)</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<style>
  :root{--bg:#f5f6f8;--card:#fff;--text:#1f2937;--muted:#6b7280;--accent:#2563eb;
        --border:#e5e7eb;--shadow:0 2px 8px rgba(0,0,0,.05);--radius:12px;--gap:14px;}
  *{box-sizing:border-box}
  body{margin:0;font-family:"Segoe UI",Roboto,system-ui,-apple-system,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{padding:18px;max-width:1500px;margin:auto}
  .header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:18px}
  .title{font-weight:700}
  .filters{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px;cursor:pointer;
        box-shadow:var(--shadow);font-size:12px;user-select:none}
  .chip.active{border-color:var(--accent);color:var(--accent);font-weight:600}
  .reset{margin-left:8px;background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--gap)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .kpi .label{color:var(--muted);font-size:12px;font-weight:600}
  .kpi .value{font-size:34px;font-weight:800;margin-top:6px}
  .row{display:grid;grid-template-columns:1.5fr 1fr;gap:var(--gap);margin-top:var(--gap)}
  #map{height:520px;border-radius:12px}
  .table{width:100%;border-collapse:collapse;font-size:14px}
  .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
  .note{font-size:13px;color:#b45309;margin-top:8px}
  @media (max-width:1100px){.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">PRV â€” Modes de garde collectif Ã  Nantes</div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="filters" id="filters"></div>
      <button id="btnReset" class="reset" title="RÃ©initialiser les filtres">RÃ©initialiser</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid">
    <div class="card kpi"><div class="label">Nb places (collectif)</div><div class="value" id="kpiPlaces">â€“</div></div>
    <div class="card kpi"><div class="label">Nombre de crÃ¨ches</div><div class="value" id="kpiCreches">â€“</div></div>
    <div class="card kpi"><div class="label">Places / 1000 hab</div><div class="value" id="kpiPer1k">â€“</div></div>
    <div class="card kpi"><div class="label">Population</div><div class="value" id="kpiPop">â€“</div></div>
  </div>

  <!-- Carte + Graphiques -->
  <div class="row">
    <div class="card" style="padding:0;overflow:hidden">
      <div style="padding:12px 14px;color:var(--muted);font-size:12px;font-weight:600">Carte des crÃ¨ches (clic = filtre Quartier)</div>
      <div id="map"></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="card">
        <div class="label" style="margin-bottom:8px">Places par quartier (empilÃ© par type) â€” clic = filtre</div>
        <canvas id="barQuartier" height="150"></canvas>
      </div>
      <div class="card">
        <div class="label" style="margin-bottom:8px">RÃ©partition par type (clic = filtre)</div>
        <canvas id="donutType" height="150"></canvas>
      </div>
    </div>
  </div>

  <!-- Tableau -->
  <div class="card" style="margin-top:var(--gap);">
    <div class="label">Liste des crÃ¨ches (aprÃ¨s filtres)</div>
    <table class="table" id="tbl">
      <thead><tr><th>Nom</th><th>Quartier</th><th>Type</th><th>Places</th><th>Adresse</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="note" id="note"></div>
  </div>
</div>

<script>
const CRECHES_URL="./DataCreches.json";
const QUARTIERS_URL="./DataQuartier.json";
const COLLECTIF_TYPES=new Set(["Municipale","Associative","Micro-crÃ¨che"]);

// ðŸŽ¨ Palette unique et cohÃ©rente (carte + bar + donut)
const TYPE_COLORS = {
  "Municipale":"#2563eb",
  "Associative":"#ef4444",
  "Micro-crÃ¨che":"#f59e0b",
  "MAM":"#9333ea"
};
const FALLBACK_COLORS = ['#06b6d4','#22c55e','#e11d48','#a3e635','#14b8a6','#f97316'];

let CRECHES=[], QUARTIERS=[];
let selectedQuartier=null;
let selectedTypes=new Set(); // init Ã  tous au premier rendu

// Utils
const fmt=n=>n==null||isNaN(n)?"â€“":n.toLocaleString("fr-FR");
const sumBy=(a,k)=>a.reduce((s,r)=>s+(+r[k]||0),0);
const uniq=a=>[...new Set(a)];
const by=(arr,keys,aggKey)=>{
  // groupby multi-clÃ© (ex: quartier+type)
  const map=new Map();
  arr.forEach(r=>{
    const k=keys.map(k=>r[k]??"(N/A)").join("Â§");
    map.set(k,(map.get(k)||0)+(+r[aggKey]||0));
  });
  return map; // key = "quartierÂ§type", value = somme
};
const colorForType = (t,i=0) => TYPE_COLORS[t] || FALLBACK_COLORS[i % FALLBACK_COLORS.length];

// UI refs
const filtersDiv=document.getElementById("filters");
const btnReset=document.getElementById("btnReset");
const kpiPlaces=document.getElementById("kpiPlaces");
const kpiCreches=document.getElementById("kpiCreches");
const kpiPer1k=document.getElementById("kpiPer1k");
const kpiPop=document.getElementById("kpiPop");
const tblBody=document.querySelector("#tbl tbody");
const note=document.getElementById("note");

// ========== LEAFLET MAP ==========
const map=L.map('map').setView([47.218,-1.553],12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; OSM'}).addTo(map);
const markersLayer=L.layerGroup().addTo(map);

function radiusFor(n){const v=+n||0; return Math.max(6, Math.sqrt(v)*2);}

function updateMap(rows){
  markersLayer.clearLayers();
  const pts=[];
  rows.forEach(r=>{
    const lat=r._lat, lon=r._lon;
    if(lat==null||lon==null) return;
    const col = colorForType(r.Type);
    const marker=L.circleMarker([lat,lon],{
      radius: radiusFor(r["Nb places"]),
      color: col, fillColor: col, weight:1, fillOpacity:.85
    })
    .bindPopup(`<b>${r.Nom||"(Sans nom)"}</b><br>${r.Adresse||""}<br>${r.Quartier||""} â€¢ ${r.Type||""}<br>Places : ${fmt(r["Nb places"])}`)
    .on("click", ()=>{
      if(r.Quartier){
        selectedQuartier = (selectedQuartier===r.Quartier) ? null : r.Quartier;
        renderFilters(); updateAll();
      }
    });
    marker.addTo(markersLayer);
    pts.push([lat,lon]);
  });
  if(pts.length){
    const b=L.latLngBounds(pts);
    if(b.isValid()) map.fitBounds(b.pad(0.2));
  }
}

// ========== FILTERS ==========
function renderFilters(){
  const quartiers=uniq(CRECHES.map(c=>c.Quartier).filter(Boolean)).sort((a,b)=>a.localeCompare(b,'fr'));
  const types=uniq(CRECHES.map(c=>c.Type).filter(Boolean)).sort((a,b)=>a.localeCompare(b,'fr'));
  if(selectedTypes.size===0) types.forEach(t=>selectedTypes.add(t));
  const qHTML = `<div class="chip ${!selectedQuartier?'active':''}" data-chip="quartier" data-val="">Tous les quartiers</div>`+
    quartiers.map(q=>`<div class="chip ${q===selectedQuartier?'active':''}" data-chip="quartier" data-val="${q}">${q}</div>`).join("");
  const tHTML = types.map((t,i)=>`<div class="chip ${selectedTypes.has(t)?'active':''}" data-chip="type" data-val="${t}" style="border-color:${colorForType(t,i)};color:${colorForType(t,i)}">${t}</div>`).join("");
  filtersDiv.innerHTML=qHTML+`<span style="width:12px"></span>`+tHTML;
}

filtersDiv.addEventListener("click", e=>{
  const el=e.target.closest(".chip"); if(!el)return;
  const kind=el.dataset.chip, val=el.dataset.val;
  if(kind==="quartier") selectedQuartier = val || null;
  if(kind==="type"){
    if(selectedTypes.has(val)) selectedTypes.delete(val); else selectedTypes.add(val);
    if(selectedTypes.size===0) CRECHES.map(c=>c.Type).forEach(t=>selectedTypes.add(t)); // Ã©vite Ã©tat vide
  }
  renderFilters(); updateAll();
});

btnReset.addEventListener("click", ()=>{
  selectedQuartier=null; selectedTypes.clear();
  renderFilters(); updateAll();
});

// ========== DATA FLOW ==========
function applyFilters(){
  return CRECHES.filter(r=>{
    const okQ=!selectedQuartier || r.Quartier===selectedQuartier;
    const okT=selectedTypes.has(r.Type);
    return okQ && okT;
  });
}

function updateKPIs(rows){
  const rowsC=rows.filter(r=>COLLECTIF_TYPES.has(r.Type));
  const places=sumBy(rowsC,"Nb places");
  kpiPlaces.textContent=fmt(places);
  kpiCreches.textContent=fmt(rows.length);
  let pop=null, per1k=null;
  if(selectedQuartier){
    const micros=QUARTIERS.filter(q=>(q.Quartier||"")===selectedQuartier);
    pop=sumBy(micros,"Population (2018)");
    per1k=pop?places/(pop/1000):null;
  }
  kpiPop.textContent=pop!=null?fmt(pop):"â€“";
  kpiPer1k.textContent=per1k!=null?per1k.toFixed(2).replace('.',','):"â€“";
}

// TABLE
function updateTable(rows){
  tblBody.innerHTML=rows.map(r=>`<tr>
    <td>${r.Nom||""}</td><td>${r.Quartier||""}</td><td>${r.Type||""}</td>
    <td>${fmt(r["Nb places"])}</td><td>${r.Adresse||""}</td>
  </tr>`).join("");
  note.textContent=`${rows.length} crÃ¨che(s) affichÃ©e(s)`;
}

// ========== CHARTS ==========
let barChart, donutChart;

function buildStackedBar(rows){
  // 1) axes
  const quartiers=uniq(rows.map(r=>r.Quartier||"(N/A)")).sort((a,b)=>a.localeCompare(b,'fr'));
  const types=uniq(CRECHES.map(r=>r.Type||"(N/A)")).sort((a,b)=>a.localeCompare(b,'fr')); // base sur toutes les catÃ©gories

  // 2) agrÃ©gat quartier x type
  const m = by(rows, ["Quartier","Type"], "Nb places"); // key = "QuartierÂ§Type" â†’ sum
  const datasets = types.map((t,ti)=>{
    const color = colorForType(t,ti);
    return {
      label: t,
      backgroundColor: color,
      data: quartiers.map(q => m.get(`${q}Â§${t}`) || 0),
      stack: 'stack1'
    };
  });

  return {labels: quartiers, datasets};
}

function updateCharts(rows){
  // --- BAR STACKED PAR TYPE ---
  const barCfg = buildStackedBar(rows.filter(r=>COLLECTIF_TYPES.has(r.Type)));
  const bctx=document.getElementById("barQuartier").getContext("2d");
  if(barChart) barChart.destroy();
  barChart=new Chart(bctx,{
    type:'bar',
    data: barCfg,
    options:{
      responsive:true,
      plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label:ctx=>`${ctx.dataset.label}: ${fmt(ctx.parsed.y)}` } } },
      scales:{ x:{ stacked:true }, y:{ stacked:true, ticks:{ callback:v=>fmt(v) } } },
      onHover:(evt,active)=>{evt.native.target.style.cursor=active.length?'pointer':'default';},
      onClick:(evt,els)=>{
        if(!els.length) return;
        const idx=els[0].index;
        const q=barChart.data.labels[idx];
        selectedQuartier = (selectedQuartier===q) ? null : q;
        renderFilters(); updateAll();
      }
    }
  });

  // --- DONUT PAR TYPE (mÃªmes couleurs) ---
  const typeAgg = {};
  rows.forEach(r=>{
    typeAgg[r.Type]=(typeAgg[r.Type]||0)+(+r["Nb places"]||0);
  });
  const labelsT=Object.keys(typeAgg);
  const dataT=labelsT.map(l=>typeAgg[l]);

  const dctx=document.getElementById("donutType").getContext("2d");
  if(donutChart) donutChart.destroy();
  donutChart=new Chart(dctx,{
    type:'doughnut',
    data:{
      labels:labelsT,
      datasets:[{
        data:dataT,
        backgroundColor: labelsT.map((t,i)=> selectedTypes.has(t) ? colorForType(t,i) : '#d1d5db')
      }]
    },
    options:{
      responsive:true, cutout:'60%',
      plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label:ctx=>`${ctx.label}: ${fmt(ctx.parsed)}` } } },
      onHover:(evt,active)=>{evt.native.target.style.cursor=active.length?'pointer':'default';},
      onClick:(evt,els)=>{
        if(!els.length) return;
        const idx=els[0].index;
        const t=donutChart.data.labels[idx];
        if(selectedTypes.has(t)) selectedTypes.delete(t); else selectedTypes.add(t);
        if(selectedTypes.size===0) donutChart.data.labels.forEach(x=>selectedTypes.add(x));
        renderFilters(); updateAll();
      }
    }
  });
}

// Orchestration
function updateAll(){
  const rows=applyFilters();
  updateKPIs(rows);
  updateCharts(rows);
  updateTable(rows);
  updateMap(rows);
}

// Init
(async function init(){
  const [creches, quartiers]=await Promise.all([
    fetch(CRECHES_URL).then(r=>r.json()),
    fetch(QUARTIERS_URL).then(r=>r.json())
  ]);
  CRECHES=creches.map(d=>({
    Nom:d["Nom"], Quartier:d["Quartier"], Type:d["Type"], Adresse:d["Adresse"],
    "Nb places": +d["Nb places"]||0, _lat:d["_lat"], _lon:d["_lon"]
  }));
  QUARTIERS=quartiers.map(d=>({
    "Micro-quartier": d["Micro-quartier"], Quartier:d["Quartier"],
    "Population (2018)": +d["Population (2018)"]||0, "Superficie (kmÂ²)": +d["Superficie (kmÂ²)"]||0
  }));

  renderFilters();
  updateAll();

  // Double-clic pour reset graph par graph
  document.getElementById("barQuartier").addEventListener("dblclick", ()=>{selectedQuartier=null; renderFilters(); updateAll();});
  document.getElementById("donutType").addEventListener("dblclick", ()=>{selectedTypes.clear(); renderFilters(); updateAll();});
})();
</script>
</body>
</html>
